<!DOCTYPE html>
<html>
<head>
    <title>New Message</title>
    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/new-message.css" />
    
    <script src="../js/utils.js"></script>
    <script src="../js/database.js"></script>
</head>
<body>

<form class="new-message-form" onsubmit="return false;">
    <h1 class="new-message-form__title">New Message</h1>

    <div class="form-group">
        <label for="txtRecipient" class="form-group__label">To (Username):</label>
        <input type="text" id="txtRecipient" class="form-group__input" placeholder="Enter a username..." />
    </div>

    <div class="form-group">
        <label for="txtPhone" class="form-group__label">Phone Number:</label>
        <input type="tel" id="txtPhone" class="form-group__input" placeholder="Enter phone (e.g., +123456789)" />
    </div>

    <div class="form-group">
        <label for="txtMessageContent" class="form-group__label">Message:</label>
        <textarea id="txtMessageContent" class="form-group__textarea" placeholder="Type your message..."></textarea>
    </div>

    <div class="new-message-form__actions">
        <button id="btnCancel" class="button button--secondary" onclick="window.parent.closeNewMessageModal()">Cancel</button>
        
        <button id="btnSendMessage" class="button button--primary" onclick="handleSendNewMessage()">Send</button>
    </div>
</form>

<script type"text/javascript">
    async function handleSendNewMessage() {
        const username = document.getElementById("txtRecipient").value;
        const phone = document.getElementById("txtPhone").value;
        const messageContent = document.getElementById("txtMessageContent").value;
        
        if (!username || !phone || !messageContent) {
            alert("Please fill in all fields.");
            return;
        }

        // Get our own user ID from the parent
        const currentUser = window.parent.currentUser;

        try {
            // We'll create this new function in database.js
            const recipient = await findUserByUsernameAndPhone(username, phone);

            if (!recipient) {
                alert("Error: User not found. Check the username and phone number.");
                return;
            }

            // 1. Send the message
            await sendMessage(currentUser.UserAccountID, recipient.UserAccountID, messageContent, 'text');

            // 2. Tell the parent "hub" that we're done
            window.parent.onNewMessageSent(recipient.UserAccountID);

        } catch (error) {
            console.error("Error sending message:", error);
            alert("An error occurred. See console for details.");
        }
    }
</script>

</body>
</html>