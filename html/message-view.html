<!DOCTYPE html>
<html>
<head>
    <title>Message List</title>
    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/message-view.css" />

    <script src="../js/utils.js"></script>
    <script src="../js/database.js"></script>

    <script type="text/javascript">

        // This function is CALLED BY main.html
        async function loadContacts() {
            // NEW: 1. Check if the function is even being called
            console.log("Message-view: loadContacts() called.");

            const listElement = document.getElementById("contact-list");
            const currentUser = window.parent.currentUser;

            if (!currentUser) {
                console.error("Message-view: No current user found in parent window.");
                return;
            }

            // NEW: 2. Log the user ID to make sure it's correct
            console.log("Message-view: Loading contacts for UserAccountID:", currentUser.UserAccountID);

            // Clear the list
            listElement.innerHTML = EMPTY_STRING;

            const chatList = await getUserChatList(currentUser.UserAccountID);

            // NEW: 3. Log the list of contact IDs
            console.log("Message-view: Fetched chat list (User IDs):", chatList);

            if (chatList.length === 0) {
                console.warn("Message-view: No contacts found in chat list.");
                listElement.innerHTML = "<p style='padding: 20px; color: #64748B; font-size: 14px;'>No contacts yet.</p>";
                return;
            }

            // 2. Get all users in the chat list in a single call
            const users = await getUsersByIds(chatList);

            // --- NEW LOGGING ADDED ---
            console.log("Message-view: All fetched contacts (chats):", users);
            // -------------------------

            // 3. Loop through each user and create the HTML
            for (const user of users) {

                // 3. Create the HTML for this contact
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';

                chatItem.onclick = function() {
                    window.parent.onContactSelected(user.UserAccountID);
                };

                const avatar = document.createElement('div');
                avatar.className = 'chat-item__avatar';
                avatar.innerText = (user.firstName[0] + user.lastName[0]).toUpperCase();

                const content = document.createElement('div');
                content.className = 'chat-item__content';

                const name = document.createElement('h3');
                name.className = 'chat-item__name';
                name.innerText = user.firstName + " " + user.lastName;

                const preview = document.createElement('p');
                preview.className = 'chat-item__preview';
                preview.innerText = "Click to view chat...";

                content.appendChild(name);
                content.appendChild(preview);
                chatItem.appendChild(avatar);
                chatItem.appendChild(content);

                listElement.appendChild(chatItem);

                // NEW: 5. Confirm that the contact was added to the HTML
                console.log("Message-view: Successfully added contact to list:", user.userName);
            }
        }
    </script>
</head>
<body>

<div class="message-list">
    <header class="message-list__header">
        <h1 class="message-list__title">Messages</h1>
        <button class="message-list__new-button" onclick="window.parent.openNewMessageModal()" title="New Message">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.5 6.5L17.5 10.5M4 20H8L18.5 9.5C19.0304 8.96957 19.3284 8.25043 19.3284 7.5C19.3284 6.74957 19.0304 6.03043 18.5 5.5C17.9696 4.96957 17.2504 4.67157 16.5 4.67157C15.7496 4.67157 15.0304 4.96957 14.5 5.5L4 16V20Z" stroke="#0EA5E9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </header>

    <div class="message-list__items" id="contact-list">
    </div>

</div>

</body>
</html>