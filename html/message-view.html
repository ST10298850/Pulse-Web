<!DOCTYPE html>
<html>
<head>
    <title>Message List</title>
    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/message-view.css" />

    <script src="../js/utils.js"></script>
    <script src="../js/database.js"></script>

    <script type="text/javascript">

        let pollingInterval = null;

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval); // Clear any existing timer
            pollingInterval = setInterval(loadContacts, 5000);
        }
        
        // --- NEW: Non-destructive visual update functions ---

        // Called by parent to set the active item
        function updateActiveVisuals(contactId) {
            const listElement = document.getElementById("contact-list");
            // Remove active class from all other items
            const allItems = listElement.querySelectorAll('.chat-item');
            allItems.forEach(item => {
                if (item.dataset.contactId !== contactId) {
                    item.classList.remove('chat-item--active');
                } else {
                    item.classList.add('chat-item--active');
                }
            });
        }

        // Called by parent to update the unread status of a single item
        function updateUnreadVisuals(contactId, hasUnread) {
            const item = document.querySelector(`.chat-item[data-contact-id='${contactId}']`);
            if (item) {
                if (hasUnread) {
                    item.classList.add('chat-item--unread');
                } else {
                    item.classList.remove('chat-item--unread');
                }
            }
        }

        // --- REWRITTEN: Intelligent DOM patching instead of full reload ---
        async function loadContacts() {
            console.log("Message-view: loadContacts() called.");

            const listElement = document.getElementById("contact-list");
            const currentUser = window.parent.currentUser;
            const activeContactId = window.parent.activeContactId; // Get state from parent

            if (!currentUser) {
                console.error("Message-view: No current user found in parent window.");
                return;
            }

            console.log("Message-view: Loading contacts for UserAccountID:", currentUser.UserAccountID);

            const chatList = await getUserChatList(currentUser.UserAccountID);
            console.log("Message-view: Fetched chat list (User IDs):", chatList);

            if (chatList.length === 0) {
                if (!listElement.hasChildNodes()) {
                    listElement.innerHTML = "<p style='padding: 20px; color: #64748B; font-size: 14px;'>No contacts yet.</p>";
                }
                return;
            }

            // Fetch latest data
            const latestMessageIds = await getLatestMessagePerChat(currentUser.UserAccountID, chatList);
            const chatReadState = window.parent.chatState;
            const users = await getUsersByIds(chatList);
            console.log("Message-view: All fetched contacts (chats):", users);

            // --- INTELLIGENT UPDATE LOGIC ---
            for (const user of users) {
                const contactId = user.UserAccountID;
                let chatItem = listElement.querySelector(`.chat-item[data-contact-id='${contactId}']`);

                // 1. If the item doesn't exist in the DOM, create it
                if (!chatItem) {
                    chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.dataset.contactId = contactId; // Use data-attributes to identify elements

                    chatItem.onclick = function() {
                        // ONLY tell the parent what happened. Do not reload here.
                        window.parent.onContactSelected(contactId);
                    };

                    const avatar = document.createElement('div');
                    avatar.className = 'chat-item__avatar';
                    avatar.innerText = (user.firstName[0] + user.lastName[0]).toUpperCase();

                    const content = document.createElement('div');
                    content.className = 'chat-item__content';

                    const name = document.createElement('h3');
                    name.className = 'chat-item__name';
                    name.innerText = user.firstName + " " + user.lastName;

                    const preview = document.createElement('p');
                    preview.className = 'chat-item__preview';
                    preview.innerText = "Click to view chat...";

                    content.appendChild(name);
                    content.appendChild(preview);
                    chatItem.appendChild(avatar);
                    chatItem.appendChild(content);

                    listElement.appendChild(chatItem);
                    console.log("Message-view: Created new DOM element for contact:", user.userName);
                }

                // 2. Update its state (active and unread)
                // Active state
                if (contactId === activeContactId) {
                    chatItem.classList.add('chat-item--active');
                } else {
                    chatItem.classList.remove('chat-item--active');
                }

                // Unread state
                const latestMessageId = latestMessageIds[user.UserAccountID] || 0;
                const lastReadId = chatReadState[user.UserAccountID] || 0;

                if (latestMessageId > lastReadId) {
                    chatItem.classList.add('chat-item--unread');
                } else {
                    chatItem.classList.remove('chat-item--unread');
                }
            }
        }
    </script>
</head> 
<body>

<div class="message-list">
    <header class="message-list__header">
        <h1 class="message-list__title">Messages</h1>
        <button class="message-list__new-button" onclick="window.parent.openNewMessageModal()" title="New Message">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.5 6.5L17.5 10.5M4 20H8L18.5 9.5C19.0304 8.96957 19.3284 8.25043 19.3284 7.5C19.3284 6.74957 19.0304 6.03043 18.5 5.5C17.9696 4.96957 17.2504 4.67157 16.5 4.67157C15.7496 4.67157 15.0304 4.96957 14.5 5.5L4 16V20Z" stroke="#0EA5E9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </header>

    <div class="message-list__items" id="contact-list">
    </div>

</div>

</body>
</html>